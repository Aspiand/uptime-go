name: Create Tag

on:
  push:
    branches:
      - main
    paths:
      - 'cmd/version.go'

jobs:
  create-tag:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: get_version
        run: |
          VERSION=$(grep -o 'VERSION = "[^"]*"' cmd/version.go | grep -o '"[^"]*"' | tr -d '"')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Detected version: ${VERSION}"

      - name: Create and push tag
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const version = '${{ steps.get_version.outputs.version }}';
            const tag = `v${version}`;
            
            try {
              // Check if tag already exists
              await github.rest.git.getRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `tags/${tag}`
              });
              console.log(`Tag ${tag} already exists, skipping creation`);
            } catch (error) {
              if (error.status === 422) {
                // Tag doesn't exist, create it
                const sha = context.sha;
                await github.rest.git.createRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `refs/tags/${tag}`,
                  sha: sha
                });
                console.log(`Tag ${tag} created successfully`);
              } else {
                throw error;
              }
            }